@page "/org/actions"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Volonterko.Data
@using Volonterko.Domain.Constants
@using Volonterko.Domain.Enums

@inject UserManager<ApplicationUser> UserManager
@inject Volonterko.Services.OrganizationService OrgService
@inject Volonterko.Services.VolunteerActionService ActionService
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = Roles.Organization)]

<h3>Moje akcije</h3>

@if (_loading)
{
    <p>Učitavanje...</p>
}
else if (_org is null)
{
    <div class="alert alert-warning">Nema organizacije vezane uz ovaj račun.</div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="GoNew">Nova akcija</button>
    </div>

    if (_actions.Count == 0)
    {
        <div class="alert alert-secondary">Trenutno nema akcija.</div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Naziv</th>
                    <th>Grad</th>
                    <th>Početak</th>
                    <th>Status</th>
                    <th class="text-end"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var a in _actions)
                {
                    <tr>
                        <td>@a.Title</td>
                        <td>@a.City</td>
                        <td>@a.StartDateTime.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>
                            @if (a.Status == VolunteerActionStatus.Draft)
                            {
                                <span class="badge bg-secondary">Draft</span>
                            }
                            else if (a.Status == VolunteerActionStatus.Published)
                            {
                                <span class="badge bg-success">Published</span>
                            }
                            else if (a.Status == VolunteerActionStatus.Completed)
                            {
                                <span class="badge bg-primary">Completed</span>
                            }
                            else if (a.Status == VolunteerActionStatus.Cancelled)
                            {
                                <span class="badge bg-danger">Cancelled</span>
                            }
                            else
                            {
                                <span class="badge bg-dark">@a.Status</span>
                            }
                        </td>

                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2"
                                    @onclick="() => GoEdit(a.Id)">
                                Detalji
                            </button>

                            <button class="btn btn-sm btn-outline-secondary me-2"
                                    @onclick="() => GoEdit(a.Id)"
                                    disabled="@(a.Status != VolunteerActionStatus.Draft)">
                                Uredi
                            </button>

                            @if (a.Status == VolunteerActionStatus.Draft)
                            {
                                <button class="btn btn-sm btn-success me-2" @onclick="() => Publish(a.Id)">Publish</button>
                            }
                            else if (a.Status == VolunteerActionStatus.Published)
                            {
                                <button class="btn btn-sm btn-warning me-2" @onclick="() => Unpublish(a.Id)">Unpublish</button>
                            }

                            <button class="btn btn-sm btn-outline-danger" @onclick="() => AskDelete(a.Id)">Obriši</button>
                        </td>
                    </tr>

                    @if (_confirmDeleteId == a.Id)
                    {
                        <tr>
                            <td colspan="5">
                                <div class="alert alert-warning mb-0 d-flex justify-content-between align-items-center">
                                    <div>Sigurno želiš obrisati akciju <b>@a.Title</b>?</div>
                                    <div>
                                        <button class="btn btn-sm btn-danger me-2" @onclick="() => ConfirmDelete(a.Id)">Da, obriši</button>
                                        <button class="btn btn-sm btn-secondary" @onclick="CancelDelete">Odustani</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }

    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <div class="alert alert-info">@_message</div>
    }
}

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private bool _loading = true;
    private string? _message;

    private int? _confirmDeleteId = null;

    private Volonterko.Domain.Entities.Organization? _org;
    private List<Volonterko.Domain.Entities.VolunteerAction> _actions = new();

    protected override async Task OnInitializedAsync()
    {
        await Reload();
    }

    private async Task Reload()
    {
        _loading = true;
        _message = null;

        var user = await GetCurrentUserAsync();
        if (user is null)
        {
            _loading = false;
            return;
        }

        _org = await OrgService.GetByOwnerUserIdAsync(user.Id);
        if (_org is not null)
            _actions = await ActionService.GetForOrganizationAsync(_org.Id);

        _loading = false;
    }

    private void GoNew() => NavigationManager.NavigateTo("/org/actions/new");

    private void GoEdit(int id) => NavigationManager.NavigateTo("/org/actions/edit/" + id);

    private async Task Publish(int id)
    {
        await ActionService.SetStatusAsync(id, VolunteerActionStatus.Published);
        _message = "Akcija je objavljena.";
        await Reload();
    }

    private async Task Unpublish(int id)
    {
        await ActionService.SetStatusAsync(id, VolunteerActionStatus.Draft);
        _message = "Akcija je vraćena u Draft.";
        await Reload();
    }

    private void AskDelete(int id) => _confirmDeleteId = id;

    private void CancelDelete() => _confirmDeleteId = null;

    private async Task ConfirmDelete(int id)
    {
        _confirmDeleteId = null;
        await Delete(id);
    }
    private async Task Delete(int id)
    {
        var ok = await ActionService.DeleteAsync(id);

        if (!ok)
        {
            _message = "Ne možeš obrisati akciju jer već postoje prijave (povijest/sati bi se izgubili).";
            return;
        }

        _message = "Akcija je obrisana.";
        await Reload();
    }


    private async Task<ApplicationUser?> GetCurrentUserAsync()
    {
        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        if (principal?.Identity?.IsAuthenticated != true) return null;
        return await UserManager.GetUserAsync(principal);
    }
}
