@page "/org/actions/new"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Volonterko.Data
@using Volonterko.Domain.Constants
@using Volonterko.Domain.Entities
@using Volonterko.Domain.Enums

@inject UserManager<ApplicationUser> UserManager
@inject Volonterko.Services.OrganizationService OrgService
@inject Volonterko.Services.VolunteerActionService ActionService
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = Roles.Organization)]

<h3>Nova akcija</h3>

@if (_loading)
{
    <p>Učitavanje...</p>
}
else if (_org is null)
{
    <div class="alert alert-warning">Nema organizacije vezane uz ovaj račun.</div>
}
else
{
    <EditForm EditContext="_editContext" OnSubmit="HandleSubmit" FormName="OrgActionNewForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Naziv</label>
            <input class="form-control" value="@_model.Title" @oninput="OnTitleChanged" />
        </div>

        <div class="mb-3">
            <label class="form-label">Opis</label>
            <textarea class="form-control" rows="4" @oninput="OnDescriptionChanged">@_model.Description</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Grad</label>
            <input class="form-control" value="@_model.City" @oninput="OnCityChanged" />
        </div>

        <div class="mb-3">
            <label class="form-label">Adresa (opcionalno)</label>
            <input class="form-control" value="@_model.Address" @oninput="OnAddressChanged" />
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Početak (datum)</label>
                <input type="date"
                       class="form-control"
                       value="@_model.StartDate"
                       @oninput="OnStartDateChanged" />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Početak (HH:mm)</label>
                <input type="time"
                       class="form-control"
                       step="60"
                       value="@_model.StartTime"
                       @oninput="OnStartTimeChanged" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Kraj (datum)</label>
                <input type="date"
                       class="form-control"
                       min="@StartDateMin"
                       value="@_model.EndDate"
                       @oninput="OnEndDateChanged" />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Kraj (HH:mm)</label>
                <input type="time"
                       class="form-control"
                       step="60"
                       min="@EndTimeMin"
                       value="@_model.EndTime"
                       @oninput="OnEndTimeChanged" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Broj potrebnih volontera</label>
            <input type="number" class="form-control" value="@_model.RequiredVolunteers" @oninput="OnRequiredChanged" />
        </div>

        <button class="btn btn-primary" type="submit" disabled="@_busy">Spremi (Draft)</button>
        <button class="btn btn-secondary ms-2" type="button" @onclick="Cancel">Odustani</button>

        @if (!string.IsNullOrWhiteSpace(_message))
        {
            <div class="mt-3 alert alert-info">@_message</div>
        }
    </EditForm>
}

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private bool _loading = true;
    private bool _busy = false;
    private string? _message;

    private Volonterko.Domain.Entities.Organization? _org;

    private Model _model = new();
    private EditContext _editContext = default!;

    private string StartDateMin => _model.StartDate;
    private string EndTimeMin => _model.EndDate == _model.StartDate ? _model.StartTime : "00:00";

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);

        var user = await GetCurrentUserAsync();
        if (user is not null)
            _org = await OrgService.GetByOwnerUserIdAsync(user.Id);

        NormalizeDates();
        _loading = false;
    }

    private void Cancel() => NavigationManager.NavigateTo("/org/actions");

    // ---- input handlers (no inline lambdas) ----
    private void OnTitleChanged(ChangeEventArgs e) => _model.Title = e.Value?.ToString() ?? "";
    private void OnDescriptionChanged(ChangeEventArgs e) => _model.Description = e.Value?.ToString();
    private void OnCityChanged(ChangeEventArgs e) => _model.City = e.Value?.ToString() ?? "";
    private void OnAddressChanged(ChangeEventArgs e) => _model.Address = e.Value?.ToString();

    private void OnStartDateChanged(ChangeEventArgs e) { _model.StartDate = e.Value?.ToString() ?? _model.StartDate; NormalizeDates(); }
    private void OnStartTimeChanged(ChangeEventArgs e) { _model.StartTime = e.Value?.ToString() ?? _model.StartTime; NormalizeDates(); }
    private void OnEndDateChanged(ChangeEventArgs e) { _model.EndDate = e.Value?.ToString() ?? _model.EndDate; NormalizeDates(); }
    private void OnEndTimeChanged(ChangeEventArgs e) { _model.EndTime = e.Value?.ToString() ?? _model.EndTime; NormalizeDates(); }

    private void OnRequiredChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var n))
            _model.RequiredVolunteers = n;
    }

    private void NormalizeDates()
    {
        if (!DateTime.TryParse(_model.StartDate, out var sd)) sd = DateTime.Today;
        if (!DateTime.TryParse(_model.EndDate, out var ed)) ed = sd;

        // end date cannot be earlier
        if (ed.Date < sd.Date)
        {
            ed = sd.Date;
            _model.EndDate = ed.ToString("yyyy-MM-dd");
        }

        if (!TimeSpan.TryParse(_model.StartTime, out var st)) st = new TimeSpan(9, 0, 0);
        if (!TimeSpan.TryParse(_model.EndTime, out var et)) et = new TimeSpan(12, 0, 0);

        // on same day: end time must be after start time
        if (ed.Date == sd.Date && et <= st)
        {
            var pushed = st.Add(TimeSpan.FromHours(1));
            _model.EndTime = pushed.ToString(@"hh\:mm");
        }
    }

    private async Task HandleSubmit(EditContext _)
    {
        _message = null;

        if (_org is null)
        {
            _message = "Nema organizacije vezane uz ovaj račun.";
            return;
        }

        NormalizeDates();

        if (!DateTime.TryParse(_model.StartDate, out var sd) || !DateTime.TryParse(_model.EndDate, out var ed))
        {
            _message = "Neispravan datum.";
            return;
        }

        if (!TimeSpan.TryParse(_model.StartTime, out var st) || !TimeSpan.TryParse(_model.EndTime, out var et))
        {
            _message = "Vrijeme mora biti u formatu HH:mm (npr. 09:00).";
            return;
        }

        var start = sd.Date + st;
        var end = ed.Date + et;

        if (end <= start)
        {
            _message = "Kraj mora biti nakon početka.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_model.Title) || string.IsNullOrWhiteSpace(_model.City))
        {
            _message = "Naziv i grad su obavezni.";
            return;
        }

        _busy = true;

        var entity = new VolunteerAction
        {
            OrganizationId = _org.Id,
            Title = _model.Title.Trim(),
            Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description.Trim(),
            City = _model.City.Trim(),
            Address = string.IsNullOrWhiteSpace(_model.Address) ? null : _model.Address.Trim(),
            StartDateTime = start,
            EndDateTime = end,
            RequiredVolunteers = Math.Max(1, _model.RequiredVolunteers),
            Status = VolunteerActionStatus.Draft
        };

        var id = await ActionService.CreateAsync(entity);

        _busy = false;
        NavigationManager.NavigateTo("/org/actions/edit/" + id);
    }

    private async Task<ApplicationUser?> GetCurrentUserAsync()
    {
        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        if (principal?.Identity?.IsAuthenticated != true) return null;
        return await UserManager.GetUserAsync(principal);

    }

    private class Model
    {
        public string Title { get; set; } = "";
        public string? Description { get; set; }
        public string City { get; set; } = "";
        public string? Address { get; set; }

        public string StartDate { get; set; } = DateTime.Today.ToString("yyyy-MM-dd");
        public string EndDate { get; set; } = DateTime.Today.ToString("yyyy-MM-dd");
        public string StartTime { get; set; } = "09:00";
        public string EndTime { get; set; } = "12:00";

        public int RequiredVolunteers { get; set; } = 5;
    }
}
